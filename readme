# ğŸ” User Authentication Service

API REST para autenticaciÃ³n de usuarios construida con **Node.js**, **TypeScript**, **Express**, **Prisma** y **PostgreSQL** usando **Arquitectura Hexagonal**.

## ğŸ“‹ Tabla de Contenidos

- [CaracterÃ­sticas](#-caracterÃ­sticas)
- [TecnologÃ­as](#-tecnologÃ­as)
- [Arquitectura](#-arquitectura)
- [Requisitos Previos](#-requisitos-previos)
- [InstalaciÃ³n](#-instalaciÃ³n)
- [ConfiguraciÃ³n](#-configuraciÃ³n)
- [Base de Datos](#-base-de-datos)
- [EjecuciÃ³n](#-ejecuciÃ³n)
- [Endpoints](#-endpoints)
- [Estructura del Proyecto](#-estructura-del-proyecto)
- [Herramientas de BD](#-herramientas-de-base-de-datos)
- [Comandos Ãštiles](#-comandos-Ãºtiles)
- [Troubleshooting](#-troubleshooting)

## âœ¨ CaracterÃ­sticas

- ğŸ”’ **Registro de usuarios** con validaciÃ³n de datos
- ğŸ”‘ **Login de usuarios** con autenticaciÃ³n JWT
- ğŸ›¡ï¸ **Hash de contraseÃ±as** con bcrypt
- ğŸ‘¥ **Sistema de cÃ³digos de amigo** Ãºnicos
- ğŸ“Š **ORM Prisma** para manejo de base de datos
- ğŸ—ï¸ **Arquitectura Hexagonal** (Clean Architecture)
- âœ… **ValidaciÃ³n con Zod**
- ğŸŒ **CORS habilitado**
- ğŸ“ **Logs detallados**

## ğŸ›  TecnologÃ­as

- **Runtime**: Node.js 18+
- **Lenguaje**: TypeScript
- **Framework**: Express.js
- **ORM**: Prisma
- **Base de Datos**: PostgreSQL (AWS RDS)
- **AutenticaciÃ³n**: JWT (jsonwebtoken)
- **Hash**: bcrypt
- **ValidaciÃ³n**: Zod
- **Variables de Entorno**: dotenv

## ğŸ— Arquitectura

```
ğŸ“¦ Arquitectura Hexagonal (Ports & Adapters)
â”œâ”€â”€ ğŸ¯ Domain (NÃºcleo)
â”‚   â”œâ”€â”€ Models (Entidades)
â”‚   â”œâ”€â”€ Ports (Interfaces)
â”‚   â””â”€â”€ Services (LÃ³gica de Negocio)
â”œâ”€â”€ ğŸ”Œ Adapters
â”‚   â”œâ”€â”€ Driving (Entrada) - Controllers
â”‚   â””â”€â”€ Driven (Salida) - Repositories
â””â”€â”€ ğŸ­ Infrastructure
    â””â”€â”€ Dependency Injection
```

## ğŸ“‹ Requisitos Previos

- **Node.js** 18+ y **npm**
- **PostgreSQL** (local o en la nube)
- **Git**

## ğŸš€ InstalaciÃ³n

### 1. Clonar el repositorio
```bash
git clone <repository-url>
cd User_authentication_service
```

### 2. Instalar dependencias
```bash
npm install
```

### 3. Instalar dependencias de desarrollo
```bash
npm install -D tsx nodemon @types/node @types/express @types/bcrypt @types/jsonwebtoken @types/cors
```

## âš™ï¸ ConfiguraciÃ³n

### 1. Crear archivo de variables de entorno
```bash
cp .env.example .env
```

### 2. Configurar variables en `.env`

## ğŸ—„ï¸ Base de Datos

### InformaciÃ³n de ConexiÃ³n
- **Host**: `localhost`
- **Puerto**: `5432`
- **Base de Datos**: `postgres`
- **Schema**: `watpato`
- **Usuario**: `postgres`

### Comandos de Prisma

#### 1. Generar cliente de Prisma
```bash
npx prisma generate
```

#### 2. Sincronizar schema con BD
```bash
npx prisma db push
```

#### 3. Ver datos con Prisma Studio
```bash
npx prisma studio
```

#### 4. Reset de base de datos (âš ï¸ CUIDADO - Borra todos los datos)
```bash
npx prisma migrate reset
```

#### 5. Ver informaciÃ³n de la BD
```bash
npx prisma db pull
```

## ğŸ¯ EjecuciÃ³n

### Desarrollo
```bash
npm run dev
```

### ProducciÃ³n
```bash
npm run build
npm start
```

### Scripts disponibles
```bash
npm run dev          # Ejecutar en modo desarrollo (con nodemon)
npm run build        # Compilar TypeScript
npm start            # Ejecutar versiÃ³n compilada
npm run prisma:generate  # Generar cliente Prisma
npm run prisma:push      # Sincronizar schema
npm run prisma:reset     # Reset de BD
```

## ğŸ”— Endpoints

### Base URL
```
http://localhost:3000
```

### Salud del servicio
```http
GET /health
```

### AutenticaciÃ³n

#### Registro de Usuario
```http
POST /api/auth/register
Content-Type: application/json

{
  "username": "johndoe",
  "email": "john@example.com",
  "password": "password123"
}
```

**Respuesta exitosa (201)**:
```json
{
  "success": true,
  "message": "User registered successfully",
  "data": {
    "id": "1",
    "username": "johndoe",
    "email": "john@example.com",
    "friendCode": "#ABC123",
    "createdAt": "2025-07-03T15:30:45.000Z"
  }
}
```

#### Login de Usuario
```http
POST /api/auth/login
Content-Type: application/json

{
  "email": "john@example.com",
  "password": "password123"
}
```

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "message": "Login successful",
  "data": {
    "user": {
      "id": "1",
      "username": "johndoe",
      "email": "john@example.com",
      "friendCode": "#ABC123"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

### Debug (Solo desarrollo)
```http
GET /api/debug/users
```

## ğŸ“ Estructura del Proyecto

```
src/
â”œâ”€â”€ register/
â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”œâ”€â”€ models/           # User.model.ts
â”‚   â”‚   â”œâ”€â”€ ports/            # Interfaces (UserRepository, PasswordService)
â”‚   â”‚   â””â”€â”€ services/         # RegisterService.ts
â”‚   â””â”€â”€ adapters/
â”‚       â”œâ”€â”€ driven/           # Implementaciones (BD, servicios)
â”‚       â””â”€â”€ driving/          # Controllers HTTP
â”œâ”€â”€ login/
â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”œâ”€â”€ models/           # Auth.model.ts
â”‚   â”‚   â”œâ”€â”€ ports/            # Interfaces (AuthRepository, TokenService)
â”‚   â”‚   â””â”€â”€ services/         # LoginService.ts
â”‚   â””â”€â”€ adapters/
â”‚       â”œâ”€â”€ driven/           # Implementaciones
â”‚       â””â”€â”€ driving/          # Controllers HTTP
â”œâ”€â”€ shared/
â”‚   â”œâ”€â”€ adapters/driving/     # Rutas compartidas
â”‚   â””â”€â”€ infrastructure/       # InyecciÃ³n de dependencias
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ schema.prisma         # Schema de base de datos
â”œâ”€â”€ app.ts                    # Punto de entrada
â””â”€â”€ .env                      # Variables de entorno
```

## ğŸ”§ Herramientas de Base de Datos

### DBeaver (Recomendado)
1. **Descargar**: https://dbeaver.io/download/
2. **Nueva conexiÃ³n PostgreSQL**
3. **Configurar**:
   - Host: `localhost`
   - Puerto: `5432`
   - Base de datos: `mydb`
   - Usuario: `postgres`
   - ContraseÃ±a: `******`

### pgAdmin
1. **Descargar**: https://www.pgadmin.org/download/
2. **Configurar con los mismos datos de arriba**

### LÃ­nea de comandos (psql)
```bash
psql -h localhost -p 5432 -U postgres -d mydb
```

### Comandos SQL Ãºtiles
```sql
-- Cambiar al schema correcto
SET search_path TO watpato;

-- Ver todos los usuarios
SELECT * FROM users ORDER BY created_at DESC;

-- Contar usuarios
SELECT COUNT(*) FROM users;

-- Ver tablas
\dt
```

## ğŸ“‹ Comandos Ãštiles

### Desarrollo
```bash
# Reiniciar servidor (durante ejecuciÃ³n)
rs

# Ver logs de Prisma
DEBUG=prisma:* npm run dev

# Limpiar node_modules
rm -rf node_modules package-lock.json
npm install
```

### Base de Datos
```bash
# Verificar conexiÃ³n
npx prisma db execute --command "SELECT 1"

# Ver estado de migraciones
npx prisma migrate status

# Formatear schema
npx prisma format
```

### Testing con curl
```bash
# Registrar usuario
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","email":"test@example.com","password":"password123"}'

# Login
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123"}'

# Health check
curl http://localhost:3000/health
```

## ğŸš¨ Troubleshooting

### Error: "Prisma Client did not initialize"
```bash
npx prisma generate
```

### Error: "Cannot connect to database"
1. Verificar `.env` tiene `DATABASE_URL` correcta
2. Verificar conectividad de red
3. Verificar credenciales de BD

### Error: "Module not found"
```bash
npm install
npx prisma generate
```

### La BD no muestra datos
1. Verificar que estÃ©s en el schema `watpato`
2. Refrescar la vista en DBeaver (F5)
3. Verificar con: `GET /api/debug/users`

### Puerto en uso
```bash
# Cambiar puerto en .env
PORT=3001

# O matar proceso
npx kill-port 3000
```

### Logs adicionales
```bash
# Ver logs detallados de Prisma
DATABASE_URL="..." npx prisma db push --preview-feature
```

## ğŸ“Š Monitoreo

### Health Check
```bash
curl http://localhost:3000/health
```

### Estado de la aplicaciÃ³n
- âœ… **Servidor corriendo**: Puerto 3000
- âœ… **BD conectada**: Logs muestran conexiÃ³n exitosa
- âœ… **Endpoints funcionando**: `/health` responde

### Logs importantes
```
âœ… Database connected successfully
ğŸš€ Server running on port 3000
ğŸ“ Health check: http://localhost:3000/health
ğŸ” Register: POST http://localhost:3000/api/auth/register
ğŸ”‘ Login: POST http://localhost:3000/api/auth/login
```